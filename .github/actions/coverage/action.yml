name: Coverage
description: Generate and upload Code Coverage
inputs:
  github-token:
    description: "GitHub API token"
    required: true
runs:
  using: composite
  steps:
    - name: Install nightly toolchain 🧰
      run: rustup update nightly
      shell: pwsh

    - name: Set the nightly toolchain as default 🧰
      run: rustup default nightly
      shell: pwsh

    - name: Install llvm-tools 🧰
      run: rustup component add llvm-tools
      shell: pwsh

    - name: Install cargo-llvm-cov 🧰
      uses: taiki-e/install-action@v2
      with:
        tool: cargo-llvm-cov

    - name: Generate LLVM Coverage 📊
      run: cargo llvm-cov --all-features --workspace --no-fail-fast --lcov --output-path lcov.info
      shell: pwsh
      env:
        RUSTFLAGS: "-Zcoverage"
        RUSTC_BOOTSTRAP: "1"

    - name: Upload Coverage to Coveralls ⬆️
      uses: coverallsapp/github-action@v2
      with:
        github-token: ${{ inputs.github-token }}
        file: lcov.info
        debug: true
        measure: true