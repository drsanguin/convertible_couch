name: Code Coverage 📊
description: Generate and upload code coverage
inputs:
  github-token:
    description: "GitHub API token"
    required: true
runs:
  using: composite
  steps:
    - name: Install nightly Toolchain 🧰
      run: rustup update nightly
      shell: pwsh

    - name: Set nightly Toolchain as default 🧰
      run: rustup default nightly
      shell: pwsh

    - name: Install llvm-tools 🧰
      run: rustup component add llvm-tools
      shell: pwsh

    - name: Generate LLVM Coverage 📊
      env:
        CARGO_INCREMENTAL: 0
        RUSTFLAGS: -Cinstrument-coverage
        LLVM_PROFILE_FILE: convertible_couch-%p-%m.profraw
      run: cargo test
      shell: pwsh

    - name: Install grcov 🧰
      uses: taiki-e/install-action@v2
      with:
        tool: grcov

    - name: Generate lcov Coverage 📊
      run: |
        grcov . `
          --binary-path ./target/debug/ `
          --output-types lcov `
          --source-dir . `
          --branch `
          --output-path lcov.info `
          --ignore-not-existing `
          --ignore C:/*/.cargo/* `
          --ignore */src/testing/* `
          --ignore */tests/* `
          --ignore bin/src/main.rs `
          --ignore */build.rs `
          --ignore lib/src/displays_settings/windows/win_32/windows_api_based_win_32.rs `
          --ignore lib/src/speakers_settings/windows/audio_endpoint_library/dll_based_audio_endpoint_library.rs `
          --excl-line "^\s*#\[cfg\(test\)\]" `
          --excl-start "^(\s*mod tests \{)|(pub fn configure_logger\()|(impl From<ConfigErrors> for ApplicationError \{)|(impl From<SetLoggerError> for ApplicationError \{)" `
          --excl-stop "^\}"
      shell: pwsh

    - name: Upload Coverage to Coveralls ⬆️
      uses: coverallsapp/github-action@v2
      with:
        github-token: ${{ inputs.github-token }}
        file: lcov.info